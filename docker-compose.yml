---
#------------------------------------------------------------
# This docker compose describes how to run inspecteur Mes-DÃ©marches. It requires
#    - environment variables defined via .env file
#
# This configuration file defines 4 machines
#   - app: Main rails application (frontend)
#   - worker: responsible of running jobs like sending mails, virus analysis
#   - db: postgresql db
# Variables
# IMAGE : name of the docker image to run (sipf/mes-demarches)
# TAG : Tag of the image to run (eg master or devpf or b38)
#
# APP_HOST: host:port pointing to the application to allows creation of absolute links
#
# DB_DATABASE: database configuration
# DB_HOST
# DB_USERNAME
# DB_PASSWORD
#
# NETWORK_SLOT: Optional, default to 0, Number between 0 and 255 allowing to run multiple env (dev, staging)
#
# SENTRY variables to logs exception on the SEntry platform
#-------------------------------------------------------------
x-common-env: &common-env
  API_CPS_CLIENT_ID: ${API_CPS_CLIENT_ID}
  API_CPS_CLIENT_SECRET: ${API_CPS_CLIENT_SECRET}
  API_CPS_PASSWORD: ${API_CPS_PASSWORD}
  API_CPS_USERNAME: ${API_CPS_USERNAME}
  APP_HOST: ${APP_HOST}
  BASEROW_API_TOKEN: ${BASEROW_API_TOKEN}
  BASEROW_TOKEN_TABLE: ${BASEROW_TOKEN_TABLE}
  BASEROW_URL: ${BASEROW_URL:-https://api-baserow.mes-demarches.gov.pf}
  CAPYBARA_DRIVER: ${CAPYBARA_DRIVER}
  CONTACT_EMAIL: ${CONTACT_EMAIL}
  TECH_EMAIL: ${TECH_EMAIL}
  DB_DATABASE: ${DB_DATABASE}
  DB_HOST: ${DB_HOST}
  DB_PASSWORD: ${DB_PASSWORD}
  DB_POOL: ${DB_POOL}
  DB_USERNAME: ${DB_USERNAME}
  GRAPHQL_BEARER: ${GRAPHQL_BEARER}
  GRAPHQL_HOST: ${GRAPHQL_HOST}
  MAILJET_API_KEY: ${MAILJET_API_KEY}
  MAILJET_SECRET_KEY: ${MAILJET_SECRET_KEY}
  OFFICE_PATH: ${OFFICE_PATH}
  PAYZEN_TEST_LOGIN: ${PAYZEN_TEST_LOGIN}
  PAYZEN_TEST_PASSWORD: ${PAYZEN_TEST_PASSWORD}
  PAYZEN_PROD_LOGIN: ${PAYZEN_PROD_LOGIN}
  PAYZEN_PROD_PASSWORD: ${PAYZEN_PROD_PASSWORD}
  RAILS_ENV: ${ENV:-production}
  FILE_MANAGER: ${FILE_MANAGER}
  S3_ENDPOINT: ${S3_ENDPOINT}
  S3_BUCKET: ${S3_BUCKET}
  S3_ACCESS_KEY: ${S3_ACCESS_KEY}
  S3_SECRET_KEY: ${S3_SECRET_KEY}
  S3_REGION: ${S3_REGION}
  SECRET_KEY_BASE: ${SECRET_KEY_BASE}
  SCHEDULEDTASK_CRON: ${SCHEDULEDTASK_CRON}
  SENDINBLUE_SMTP_KEY: ${SENDINBLUE_SMTP_KEY}
  SENDINBLUE_USER_NAME: ${SENDINBLUE_USER_NAME}

name: inspecteur_demarches 

services:
  app:
    image: ${IMAGE}:${TAG:-latest}
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - imd-data-files:/imd/storage
      - imd-fonts:/usr/share/fonts
      #- ./DS/key.pem:/etc/ssl/private/my-site.key:ro
      #- ./DS/cert.pem:/etc/ssl/certs/my-site.crt:ro
      #- ./DS/cert.pem:/usr/local/share/ca-certificates/foo.crt:ro
    environment:
      <<: *common-env
      #SSL_CERT_DIR: /etc/ssl/certs ruby http.rb
      PORT: ${PORT}
      RAILS_RELATIVE_URL_ROOT: ${RAILS_RELATIVE_URL_ROOT}
    ports:
      - '0.0.0.0:${PORT}:${PORT}'
    networks:
      - md-network
    restart: always
    #command: chmod 644 /usr/local/share/ca-certificates/foo.crt && update-ca-certificates
    #command: sudo update-ca-certificates

  db:
    #image: postgres:latest
    image: docker.io/postgis/postgis:17-master
    environment:
      POSTGRES_INITDB_ARGS: "--data-checksums"
      POSTGRES_USER: "${DB_USERNAME}"
      POSTGRES_DB: "${DB_DATABASE}"
      POSTGRES_PASSWORD: "${DB_PASSWORD}"
      TZ: "EUROPE/PARIS"
    #ports:
    #  - "5432:5432"
    networks:
      - md-network
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "sh -c 'pg_isready -U ${DB_USERNAME} -d ${DB_DATABASE}'"]
      interval: 10s
      timeout: 3s
      retries: 3

  # need to be a 'demarches-simplifiees' platform ! > can be remove
  #graphql:
  #  image: hasura/graphql-engine:latest
  #  depends_on:
  #    db:
  #      condition: service_healthy
  #  environment:
  #    HASURA_GRAPHQL_DATABASE_URL: "postgres://${DB_USERNAME}:${DB_PASSWORD}@db:5432/${DB_DATABASE}"
  #    #HASURA_GRAPHQL_ENABLE_CONSOLE: false # set to "false" to disable console
  #    HASURA_GRAPHQL_DEV_MODE: "true"
  #    HASURA_GRAPHQL_ENABLE_TELEMETRY: "false"
  #    ## uncomment next line to set an admin secret
  #    # HASURA_GRAPHQL_ADMIN_SECRET: ${GRAPHQL_BEARER}
  #  networks:
  #    - md-network
  #  restart: always

  worker:
    image: ${IMAGE}:${TAG:-latest}
    volumes:
      - imd-data-files:/imd/storage
      - imd-fonts:/usr/share/fonts
    environment:
      <<: *common-env
    networks:
      - md-network
    command: rails jobs:work
    entrypoint: ["bundle", "exec"]
    restart: always

volumes:
  imd-data-files:
    driver: local
#    #driver_opts:
#    #  type: none
#    #  device: $ROOT/storage
#    #  o: bind
  imd-fonts:
    driver: local
#    #driver_opts:
#    #  type: none
#    #  device: /usr/share/fonts
#    #  o: bind
      
networks:
  md-network:
#  #  driver: bridge
#  #  ipam:
#  #    config:
#  #      - subnet: 10.5.2.0/24
